<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Karyawan - PT. Transwisata Prima Aviation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-2xl p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <!-- Header -->
            <div class="bg-blue-800 p-6 text-white text-center">
                <h1 class="text-2xl font-bold">Aplikasi Absensi Karyawan</h1>
                <p class="text-blue-200">PT. Transwisata Prima Aviation</p>
            </div>

            <div class="p-6 space-y-6">
                <!-- Data Karyawan -->
                <div id="section-data-karyawan" class="space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Data Karyawan</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Nama</label>
                            <input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="division" class="block text-sm font-medium text-gray-700">Divisi</label>
                            <input type="text" id="division" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="position" class="block text-sm font-medium text-gray-700">Jabatan</label>
                            <input type="text" id="position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="duty_as" class="block text-sm font-medium text-gray-700">Duty As</label>
                            <select id="duty_as" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option>Pilot</option>
                                <option>Co-Pilot</option>
                                <option>Pramugari</option>
                                <option>Teknisi</option>
                                <option>Staf</option>
                            </select>
                        </div>
                        <div>
                            <label for="work_type" class="block text-sm font-medium text-gray-700">Tipe Pekerjaan</label>
                            <select id="work_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option>Work From Office (WFO)</option>
                                <option>Work From Home (WFH)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Status Absen -->
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                     <h3 class="text-lg font-medium text-gray-700">Status Absensi Saat Ini</h3>
                     <p id="status-absen" class="text-2xl font-bold text-blue-600 mt-1">Belum Absen</p>
                </div>


                <!-- Absen Masuk -->
                <div id="section-absen-masuk" class="space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Absen Masuk</h2>
                    
                    <!-- Foto Masuk -->
                    <div class="text-center">
                        <img id="foto-masuk-preview" src="https://placehold.co/300x225/e2e8f0/94a3b8?text=Foto+Masuk" alt="Foto Masuk" class="mx-auto rounded-lg shadow-md w-full max-w-xs">
                        <button id="btn-ambil-foto-masuk" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Ambil Foto</button>
                    </div>

                    <!-- Lokasi Masuk -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Lokasi Masuk</label>
                        <div class="mt-1 flex items-center space-x-2">
                           <p id="location-masuk" class="w-full text-sm text-gray-600 bg-gray-100 p-2 rounded-md">Belum ada data lokasi</p>
                           <button id="btn-get-location-masuk" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm">Dapatkan Lokasi</button>
                        </div>
                    </div>
                    
                    <button id="btn-absen-masuk" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400">Kirim Absen Masuk</button>
                    
                    <div id="info-absen-masuk" class="hidden bg-green-50 p-4 rounded-lg">
                        <p class="font-semibold">Absen Masuk:</p>
                        <p id="waktu-absen-masuk"></p>
                        <p id="status-masuk" class="font-bold"></p>
                    </div>

                    <div id="alasan-terlambat-container" class="hidden">
                        <label for="alasan-terlambat" class="block text-sm font-medium text-gray-700">Alasan Terlambat</label>
                        <textarea id="alasan-terlambat" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <!-- Absen Pulang -->
                <div id="section-absen-pulang" class="hidden space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Absen Pulang</h2>
                    
                    <!-- Remark & Foto Pekerjaan -->
                    <div>
                        <label for="remark-pekerjaan" class="block text-sm font-medium text-gray-700">Remark Pekerjaan Hari Ini</label>
                        <textarea id="remark-pekerjaan" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="foto-pekerjaan" class="block text-sm font-medium text-gray-700">Foto Pekerjaan Hari Ini</label>
                        <input type="file" id="foto-pekerjaan" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <img id="foto-pekerjaan-preview" class="hidden mt-2 rounded-lg shadow-md w-full max-w-xs mx-auto" alt="Preview Foto Pekerjaan">
                    </div>

                    <!-- Lokasi Pulang -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Lokasi Pulang</label>
                         <div class="mt-1 flex items-center space-x-2">
                           <p id="location-pulang" class="w-full text-sm text-gray-600 bg-gray-100 p-2 rounded-md">Belum ada data lokasi</p>
                           <button id="btn-get-location-pulang" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm">Dapatkan Lokasi</button>
                        </div>
                    </div>
                    
                    <button id="btn-absen-pulang" class="w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">Kirim Absen Pulang</button>

                    <div id="info-absen-pulang" class="hidden bg-red-50 p-4 rounded-lg space-y-2">
                         <p><span class="font-semibold">Absen Pulang:</span> <span id="waktu-absen-pulang"></span></p>
                         <p><span class="font-semibold">Status Pulang:</span> <span id="status-pulang" class="font-bold"></span></p>
                         <p><span class="font-semibold">Total Waktu Kerja:</span> <span id="total-work-time"></span></p>
                         <p id="total-overtime-container" class="hidden"><span class="font-semibold">Total Lembur:</span> <span id="total-overtime"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Kamera -->
    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-4 rounded-lg shadow-xl w-full max-w-lg">
            <video id="camera-stream" class="w-full rounded-md" autoplay></video>
            <div class="mt-4 flex justify-center space-x-4">
                <button id="btn-capture" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Ambil Gambar</button>
                <button id="btn-close-modal" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Tutup</button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // State
    let clockInTime = null;
    let clockOutTime = null;
    let cameraType = null; // 'masuk' or 'pulang'

    // DOM Elements
    const getEl = (id) => document.getElementById(id);

    const elements = {
        statusAbsen: getEl('status-absen'),
        sectionDataKaryawan: getEl('section-data-karyawan'),
        sectionAbsenMasuk: getEl('section-absen-masuk'),
        sectionAbsenPulang: getEl('section-absen-pulang'),
        
        // Masuk
        btnAmbilFotoMasuk: getEl('btn-ambil-foto-masuk'),
        fotoMasukPreview: getEl('foto-masuk-preview'),
        btnGetLocationMasuk: getEl('btn-get-location-masuk'),
        locationMasuk: getEl('location-masuk'),
        btnAbsenMasuk: getEl('btn-absen-masuk'),
        infoAbsenMasuk: getEl('info-absen-masuk'),
        waktuAbsenMasuk: getEl('waktu-absen-masuk'),
        statusMasuk: getEl('status-masuk'),
        alasanTerlambatContainer: getEl('alasan-terlambat-container'),

        // Pulang
        btnGetLocationPulang: getEl('btn-get-location-pulang'),
        locationPulang: getEl('location-pulang'),
        btnAbsenPulang: getEl('btn-absen-pulang'),
        infoAbsenPulang: getEl('info-absen-pulang'),
        waktuAbsenPulang: getEl('waktu-absen-pulang'),
        statusPulang: getEl('status-pulang'),
        totalWorkTime: getEl('total-work-time'),
        totalOvertimeContainer: getEl('total-overtime-container'),
        totalOvertime: getEl('total-overtime'),
        fotoPekerjaan: getEl('foto-pekerjaan'),
        fotoPekerjaanPreview: getEl('foto-pekerjaan-preview'),

        // Modal
        cameraModal: getEl('camera-modal'),
        cameraStream: getEl('camera-stream'),
        btnCapture: getEl('btn-capture'),
        btnCloseModal: getEl('btn-close-modal'),
    };

    // --- Functions ---

    // Geolocation
    const getLocation = (element) => {
        if (navigator.geolocation) {
            element.innerHTML = '<div class="loader mx-auto"></div>';
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        element.textContent = data.display_name || 'Lokasi tidak ditemukan';
                    } catch (error) {
                        element.textContent = 'Gagal mengambil nama lokasi';
                    }
                },
                (error) => {
                    let errorMessage;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "Izin lokasi ditolak.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "Informasi lokasi tidak tersedia.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "Permintaan lokasi timed out.";
                            break;
                        default:
                            errorMessage = "Terjadi kesalahan tidak diketahui.";
                            break;
                    }
                    element.textContent = errorMessage;
                }
            );
        } else {
            element.textContent = "Geolocation tidak didukung oleh browser ini.";
        }
    };

    // Camera
    const openCamera = (type) => {
        cameraType = type;
        elements.cameraModal.classList.remove('hidden');
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                elements.cameraStream.srcObject = stream;
            })
            .catch(err => {
                alert("Tidak bisa mengakses kamera: " + err);
                closeCamera();
            });
    };

    const closeCamera = () => {
        const stream = elements.cameraStream.srcObject;
        if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop());
        }
        elements.cameraModal.classList.add('hidden');
    };

    const takePicture = () => {
        const canvas = document.createElement('canvas');
        canvas.width = elements.cameraStream.videoWidth;
        canvas.height = elements.cameraStream.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(elements.cameraStream, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL('image/png');
        
        if (cameraType === 'masuk') {
            elements.fotoMasukPreview.src = dataUrl;
        }
        
        closeCamera();
    };
    
    // Time formatting
    const formatTime = (date) => date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const formatDate = (date) => date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    // --- Event Listeners ---
    
    elements.btnAmbilFotoMasuk.addEventListener('click', () => openCamera('masuk'));
    elements.btnGetLocationMasuk.addEventListener('click', () => getLocation(elements.locationMasuk));
    elements.btnGetLocationPulang.addEventListener('click', () => getLocation(elements.locationPulang));

    elements.btnCapture.addEventListener('click', takePicture);
    elements.btnCloseModal.addEventListener('click', closeCamera);

    elements.fotoPekerjaan.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                elements.fotoPekerjaanPreview.src = e.target.result;
                elements.fotoPekerjaanPreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });

    // Absen Masuk
    elements.btnAbsenMasuk.addEventListener('click', () => {
        // Simple validation
        if (!getEl('name').value || !getEl('email').value) {
            alert('Nama dan Email wajib diisi!');
            return;
        }
        if (elements.fotoMasukPreview.src.includes('placehold.co')) {
            alert('Silakan ambil foto terlebih dahulu.');
            return;
        }
         if (elements.locationMasuk.textContent.includes('Belum ada data')) {
            alert('Silakan dapatkan lokasi terlebih dahulu.');
            return;
        }

        clockInTime = new Date();
        elements.waktuAbsenMasuk.textContent = `${formatDate(clockInTime)}, ${formatTime(clockInTime)}`;
        
        const jamMasuk = clockInTime.getHours();
        const menitMasuk = clockInTime.getMinutes();

        if (jamMasuk > 9 || (jamMasuk === 9 && menitMasuk > 0)) {
            elements.statusMasuk.textContent = "Anda Terlambat Absen";
            elements.statusMasuk.className = "font-bold text-red-600";
            elements.alasanTerlambatContainer.classList.remove('hidden');
        } else {
            elements.statusMasuk.textContent = "Terima Kasih, Anda Telah Absen Tepat Waktu";
            elements.statusMasuk.className = "font-bold text-green-600";
        }

        elements.infoAbsenMasuk.classList.remove('hidden');
        elements.statusAbsen.textContent = "On Working";
        elements.statusAbsen.className = "text-2xl font-bold text-green-600 mt-1";

        // UI update
        elements.btnAbsenMasuk.disabled = true;
        elements.btnAbsenMasuk.textContent = "Absen Masuk Telah Direkam";
        elements.btnAmbilFotoMasuk.disabled = true;
        elements.btnGetLocationMasuk.disabled = true;
        Array.from(elements.sectionDataKaryawan.querySelectorAll('input, select')).forEach(el => el.disabled = true);
        elements.sectionAbsenPulang.classList.remove('hidden');
    });

    // Absen Pulang
    elements.btnAbsenPulang.addEventListener('click', () => {
        clockOutTime = new Date();
        elements.waktuAbsenPulang.textContent = `${formatDate(clockOutTime)}, ${formatTime(clockOutTime)}`;

        const jamPulang = clockOutTime.getHours();
        const menitPulang = clockOutTime.getMinutes();

        if (jamPulang < 17) {
            elements.statusPulang.textContent = "Anda Pulang Sebelum Waktunya";
            elements.statusPulang.className = "font-bold text-yellow-600";
        } else if (jamPulang === 17 && menitPulang <= 30) {
            elements.statusPulang.textContent = "Anda Pulang Tepat Waktu";
            elements.statusPulang.className = "font-bold text-green-600";
        } else {
            elements.statusPulang.textContent = "Waktu Kerja Anda Melebihi Batas";
            elements.statusPulang.className = "font-bold text-blue-600";
            
            // Hitung overtime
            const batasWaktuKerja = new Date(clockOutTime);
            batasWaktuKerja.setHours(17, 30, 0, 0);
            
            let diffOvertime = clockOutTime - batasWaktuKerja;
            let s = Math.floor(diffOvertime / 1000);
            let m = Math.floor(s / 60);
            let h = Math.floor(m / 60);
            s = s % 60;
            m = m % 60;
            
            elements.totalOvertime.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            elements.totalOvertimeContainer.classList.remove('hidden');
        }

        // Hitung total waktu kerja
        let diffWork = clockOutTime - clockInTime;
        let s = Math.floor(diffWork / 1000);
        let m = Math.floor(s / 60);
        let h = Math.floor(m / 60);
        s = s % 60;
        m = m % 60;
        elements.totalWorkTime.textContent = `${String(h).padStart(2, '0')} jam, ${String(m).padStart(2, '0')} menit, ${String(s).padStart(2, '0')} detik`;

        elements.infoAbsenPulang.classList.remove('hidden');
        elements.statusAbsen.textContent = "Pulang";
        elements.statusAbsen.className = "text-2xl font-bold text-gray-600 mt-1";

        // UI update
        elements.btnAbsenPulang.disabled = true;
        elements.btnAbsenPulang.textContent = "Absen Pulang Telah Direkam";
        elements.btnGetLocationPulang.disabled = true;
    });
});
</script>
</body>
</html>
